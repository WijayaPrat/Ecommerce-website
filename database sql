SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 1. Tabel VENDOR
CREATE TABLE IF NOT EXISTS vendor (
    id_vendor      INT(11) AUTO_INCREMENT PRIMARY KEY,
    nama_vendor    VARCHAR(100) NOT NULL,
    kontak         VARCHAR(50),
    alamat         TEXT
) ENGINE=InnoDB;

-- 2. Tabel CUSTOMER
CREATE TABLE IF NOT EXISTS customer (
    id_customer INT(11) AUTO_INCREMENT PRIMARY KEY,
    nama        VARCHAR(100) NOT NULL,
    email       VARCHAR(100) NOT NULL UNIQUE,
    password    VARCHAR(100) NOT NULL,
    alamat      TEXT,
    no_hp       VARCHAR(20)
) ENGINE=InnoDB;

-- 3. Tabel ALAMAT PENGIRIMAN
CREATE TABLE IF NOT EXISTS alamat_pengiriman (
    id_alamat      INT(11) AUTO_INCREMENT PRIMARY KEY,
    id_customer    INT(11) NOT NULL,
    label          VARCHAR(50),        -- rumah / kantor dll
    alamat_lengkap TEXT NOT NULL,
    kota           VARCHAR(100),
    kode_pos       VARCHAR(10),
    no_hp_penerima VARCHAR(20),

    CONSTRAINT fk_alamat_customer
        FOREIGN KEY (id_customer) REFERENCES customer(id_customer)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 4. Tabel PRODUK (terhubung ke vendor)
CREATE TABLE IF NOT EXISTS produk (
    id_produk   INT(11) AUTO_INCREMENT PRIMARY KEY,
    id_vendor   INT(11) NOT NULL,
    nama_produk VARCHAR(100) NOT NULL,
    deskripsi   TEXT,
    harga       DECIMAL(10,2) NOT NULL,
    stok        INT(11) NOT NULL DEFAULT 0,

    CONSTRAINT fk_produk_vendor
        FOREIGN KEY (id_vendor) REFERENCES vendor(id_vendor)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 5. Tabel TRANSAKSI (1 transaksi = 1 vendor)
CREATE TABLE IF NOT EXISTS transaksi (
    id_transaksi      INT(11) AUTO_INCREMENT PRIMARY KEY,
    id_customer       INT(11) NOT NULL,
    id_vendor         INT(11) NOT NULL,      -- vendor pemilik barang
    id_alamat         INT(11) NOT NULL,      -- alamat pengiriman yang dipakai
    tanggal_transaksi DATETIME NOT NULL,
    total_harga       DECIMAL(10,2) NOT NULL DEFAULT 0,
    status            ENUM('pending','dibayar','dikirim','selesai','batal')
                        NOT NULL DEFAULT 'pending',

    CONSTRAINT fk_transaksi_customer
        FOREIGN KEY (id_customer) REFERENCES customer(id_customer)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_transaksi_vendor
        FOREIGN KEY (id_vendor) REFERENCES vendor(id_vendor)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_transaksi_alamat
        FOREIGN KEY (id_alamat) REFERENCES alamat_pengiriman(id_alamat)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 6. Tabel DETAIL_TRANSAKSI
CREATE TABLE IF NOT EXISTS detail_transaksi (
    id_detail     INT(11) AUTO_INCREMENT PRIMARY KEY,
    id_transaksi  INT(11) NOT NULL,
    id_produk     INT(11) NOT NULL,
    jumlah        INT(11) NOT NULL,
    subtotal      DECIMAL(10,2) NOT NULL,

    CONSTRAINT fk_detail_transaksi
        FOREIGN KEY (id_transaksi) REFERENCES transaksi(id_transaksi)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_detail_produk
        FOREIGN KEY (id_produk) REFERENCES produk(id_produk)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 7. Tabel PENGIRIMAN_BARANG
CREATE TABLE IF NOT EXISTS pengiriman_barang (
    id_pengiriman     INT(11) AUTO_INCREMENT PRIMARY KEY,
    id_transaksi      INT(11) NOT NULL,
    nomor_resi        VARCHAR(100),
    tanggal_kirim     DATETIME,
    tanggal_terima    DATETIME,
    status_pengiriman ENUM('menunggu','dikirim','dalam_perjalanan','diterima','batal')
                        NOT NULL DEFAULT 'menunggu',

    CONSTRAINT fk_pengiriman_transaksi
        FOREIGN KEY (id_transaksi) REFERENCES transaksi(id_transaksi)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 8. Tabel PEMBAYARAN (customer -> platform)
CREATE TABLE IF NOT EXISTS pembayaran (
    id_pembayaran  INT(11) AUTO_INCREMENT PRIMARY KEY,
    id_transaksi   INT(11) NOT NULL,
    metode         VARCHAR(50) NOT NULL,  -- transfer, ewallet, dll
    tanggal_bayar  DATETIME,
    jumlah         DECIMAL(10,2) NOT NULL,
    status         ENUM('pending','berhasil','gagal')
                     NOT NULL DEFAULT 'pending',

    CONSTRAINT fk_pembayaran_transaksi
        FOREIGN KEY (id_transaksi) REFERENCES transaksi(id_transaksi)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 9. Tabel PEMBAYARAN_VENDOR (pencairan ke vendor)
CREATE TABLE IF NOT EXISTS pembayaran_vendor (
    id_pencairan    INT(11) AUTO_INCREMENT PRIMARY KEY,
    id_vendor       INT(11) NOT NULL,
    id_transaksi    INT(11) NOT NULL,
    jumlah_diterima DECIMAL(10,2) NOT NULL,
    fee_platform    DECIMAL(10,2) NOT NULL DEFAULT 0,
    tanggal_cair    DATETIME,
    status_cair     ENUM('menunggu','siap_cair','sudah_cair','batal')
                      NOT NULL DEFAULT 'menunggu',

    CONSTRAINT fk_pencairan_vendor
        FOREIGN KEY (id_vendor) REFERENCES vendor(id_vendor)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_pencairan_transaksi
        FOREIGN KEY (id_transaksi) REFERENCES transaksi(id_transaksi)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

SET FOREIGN_KEY_CHECKS = 1;
